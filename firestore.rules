service cloud.firestore {
  match /databases/{database}/documents {

    // Users can only read and write their own data
    match /User/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Groups: Users can read if they are members; only the creator can modify
    match /Group/{groupId} {
      allow read: if request.auth != null && request.auth.uid in resource.data.members;
      allow write: if request.auth != null && request.auth.uid == resource.data.creator_id;
    }

    // ItineraryCard: Users can read/write if they are members of the associated group
    match /ItineraryCard/{cardId} {
      allow read, write: if request.auth != null 
        && request.auth.uid in get(/databases/$(database)/documents/Group/$(resource.data.group_id)).data.members;
    }
    
    // Default deny all other requests
    match /{document=**} {
      allow read, write: if false;
    }
  }
}