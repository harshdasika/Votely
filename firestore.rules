service cloud.firestore {
  match /databases/{database}/documents {

    // Users can only read and write their own data
    match /User/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Groups: Users can read if they are members; only the creator can create or modify membership
    match /Group/{groupId} {
      // Allow creation of a group by authenticated users
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.creator_id;

      // Allow reading group details if the user is a member
      allow read: if request.auth != null 
        && request.auth.uid in resource.data.members;

      // Allow updating membership if the user is a member or adding themselves to the group
      allow update: if request.auth != null 
        && request.resource.data.members.hasAll(resource.data.members)
        && request.auth.uid in request.resource.data.members;
    }

    // ItineraryCard: Users can read/write if they are members of the associated group
    match /ItineraryCard/{cardId} {
      allow create: if request.auth != null 
        && request.auth.uid in get(/databases/$(database)/documents/Group/$(request.resource.data.group_id)).data.members;

      allow read, update, delete: if request.auth != null 
        && request.auth.uid in get(/databases/$(database)/documents/Group/$(resource.data.group_id)).data.members;
    }

    // Default deny all other requests
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
